***
*** ACTUALIZA TABLAS GOBERNADAS POR OTRAS (SUBTABLAS CON PADRE)
*** (PUEDE RECIBIR UN FILTRO, QUE DEBERIA SER EL PADRE) WFILTRO
*** (PUEDE RECIBIR UNA CONDICION DE CAPTURA DE VALOR  ) WVALOR
***
***
PUSH KEY CLEAR
DEFI WIND WINDSUB FROM wlinsub,wcolsub TO wlinsub+10,wcolsub+78;
          TITLE WTITLE;
          FOOTER " F1=Inc, F2=Mod, F3=Eli, F4=Bus, Enter=Salir " ;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINDSUB
ON KEY LABEL F1  DO PROSUBI
ON KEY LABEL F2  DO PROSUBM
ON KEY LABEL F3  DO PROSUBE
ON KEY LABEL F4  DO PROSUBB
ON KEY LABEL ENTER KEYBOARD '{CTRL+W}'
IF WFILTRO = SPACE(10)
   IF WVALOR
      BROWSE FIELDS PADRE:H="Padre",CODIGO:H="Codigo",DESCRI:H="Descripcion",VALOR:H="Valor";
             NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDSUB
    ELSE
      BROWSE FIELDS PADRE:H="Padre",CODIGO:H="Codigo",DESCRI:H="Descripcion";
             NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDSUB
    ENDIF
ELSE
   IF WVALOR
        BROWSE FIELDS PADRE:H="Padre",CODIGO:H="Codigo",DESCRI:H="Descripcion",VALOR:H="Valor";
               NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDSUB;
               KEY WFILTRO
   ELSE
        BROWSE FIELDS PADRE:H="Padre",CODIGO:H="Codigo",DESCRI:H="Descripcion";
               NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDSUB;
               KEY WFILTRO
   ENDIF
ENDIF
DEACT WIND WINDSUB
POP KEY
RETURN

************
PROC PROSUBI
************
PUSH KEY CLEAR
STORE "INCLUIR" TO WFLAGRSUB
SCATT MEMV BLANK
DO WHILE .T.
   STORE SPACE(LEN(M.DESCRI)) TO M.DESCRI
   DO GETSUB
   IF LASTKEY()=27
      EXIT
   ENDIF
ENDDO
POP KEY
RETURN

************
PROC PROSUBM
************
PUSH KEY CLEAR
STORE "MODIFICAR" TO WFLAGRSUB
IF .NOT. EOF()
   SCATT MEMV
   DO GETSUB
ENDIF
POP KEY
RETURN

************
PROC PROSUBE
************
IF EOF()
   RETURN
ENDIF
PUSH KEY CLEAR
STORE "ELIMINAR" TO WFLAGRSUB
STORE 2 TO WOP
DO CANCACEP WITH WFLAGRSUB
IF WOP=2
   IF RECLOC()
      DELETE
      UNLOCK
   ELSE
      DO PROCNUL
   ENDIF
ENDIF
POP KEY
RETURN

************
PROC PROSUBB
************
PUSH KEY CLEAR
STORE "BUSCAR" TO WFLAGRSUB
DEFI WIND WINDBUS FROM WLINSUB+1,WCOLSUB TO WLINSUB+3,WCOLSUB+55;
          TITLE  WFLAGRSUB ;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINDBUS
DO WHILE .T.
   SCATT MEMV BLANK
   @ 0,1 GET M.PADRE
   READ
   IF LASTKEY()=27
      EXIT
   ENDIF
   IF M.PADRE<>SPACE(LEN(M.PADRE))
      SEEK M.PADRE
      IF FOUND()
         EXIT
      ELSE
         STORE "NO REGISTRADO, REINTENTE" TO WTEXT
         DO AVISO WITH WTEXT
         LOOP
      ENDIF
   ENDIF
ENDDO
RELE WIND WINDBUS
POP KEY
RETURN

***********
PROC GETSUB
***********
DEFI WIND WINDGETT FROM WLINSUB+1,WCOLSUB TO WLINSUB+6,WCOLSUB+65;
          TITLE  WFLAGRSUB ;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINDGETT
DO WHILE .T.
   @ 00,01 SAY "Padre .....:"
   @ 01,01 SAY "Codigo ....:"
   @ 02,01 SAY "Descripcion:"
   IF WVALOR
      @ 03,01 SAY "Valor .....:"
   ENDIF
   IF WFLAGRSUB="INCLUIR"
      @ 0,14 GET M.PADRE VALID VALPAD()
      READ
      IF LASTKEY()=27
         EXIT
      ENDIF
      @ 1,14 GET M.CODIGO VALID VALCOD()
      READ
      IF LASTKEY()=27
         EXIT
      ENDIF
      SEEK M.PADRE+M.CODIGO
      IF FOUND()
         @ 2,14 SAY DESCRI
         @ 3,14 SAY VALOR
         STORE "CODIGO YA EXISTE" TO WTEXT
         DO AVISO WITH WTEXT
         LOOP
      ENDIF
   ELSE
      @ 0,14 SAY M.PADRE
      @ 1,14 SAY M.CODIGO
   ENDIF
   @ 2,14   GET M.DESCRI VALID VALDES()
   *@ 3,14   GET M.VALOR WHEN WVALOR
   READ
   IF LASTKEY()=27
      EXIT
   ENDIF
   STORE 1 TO WOP
   DO ACEPCANC WITH WFLAGRSUB
   IF WOP=1
      IF WFLAGRSUB="INCLUIR"
         IF FILLOC()
            APPEND BLANK
            GATH MEMV
            UNLOCK ALL
         ELSE
           DO PROCNUL
         ENDIF
      ELSE
         IF RECLOC()
            GATH MEMV
            UNLOCK ALL
         ELSE
            DO PROCNUL
         ENDIF
      ENDIF
   ENDIF
   EXIT
ENDDO
RELE WIND WINDGETT
RETURN


***********
FUNC VALPAD
***********
SELECT 20
SEEK M.PADRE
IF FOUND()
   STORE .T.     TO WRETURN
ELSE
   store WLINSUB+1 to wlin
   store WCOLSUB+1 to wcol
   store "< CODIGOS PADRES >" TO WTITLE
   DO MTATAB
   STORE CODIGO  TO M.PADRE
   STORE .T.     TO WRETURN
ENDIF
SELECT 21
RETURN WRETURN

***********
FUNC VALCOD
***********
IF M.CODIGO<>SPACE(LEN(M.CODIGO))
   RETURN .T.
ELSE
   RETURN .F.
ENDIF
***********
FUNC VALDES
***********
IF M.DESCRI<>SPACE(LEN(M.DESCRI))
   RETURN .T.
ELSE
   RETURN .F.
ENDIF
